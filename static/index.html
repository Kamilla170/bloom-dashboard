<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± Bloom AI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .update-time { font-size: 0.9rem; opacity: 0.9; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        .stat-card h3 { font-size: 0.9rem; color: #666; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 3rem; font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .stat-percent { font-size: 1.2rem; color: #888; }
        .stat-icon { font-size: 2rem; margin-bottom: 10px; }
        .comparison { margin-top: 30px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .comparison h2 { margin-bottom: 20px; color: #667eea; }
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .day-stats { padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .day-stats h3 { color: #667eea; margin-bottom: 10px; }
        .day-stats-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0; }
        .day-stats-item:last-child { border-bottom: none; }
        .charts-section { margin-top: 30px; background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .charts-section h2 { margin-bottom: 20px; color: #667eea; }
        .chart-container { position: relative; height: 300px; margin-bottom: 30px; }
        .loading { text-align: center; padding: 40px; color: white; font-size: 1.2rem; }
        .error { background: #ff4444; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .badge-success { background: #4caf50; color: white; }
        .badge-warning { background: #ff9800; color: white; }
        .badge-info { background: #2196F3; color: white; }
        .control-panel { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .control-row { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .control-row:last-child { margin-bottom: 0; }
        .control-label { font-weight: bold; color: #667eea; min-width: 120px; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .control-btn { padding: 10px 20px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; font-size: 0.9rem; }
        .control-btn:hover { background: #f0f0f0; }
        .control-btn.active { background: #667eea; color: white; }
        .date-input, .period-input { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem; outline: none; }
        .period-input { width: 100px; text-align: center; font-size: 1rem; }
        .date-input:focus, .period-input:focus { border-color: #667eea; }
        .custom-period-inputs { display: none; gap: 10px; align-items: center; }
        .custom-period-inputs.active { display: flex; }
        .retention-info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3; }
        .retention-info h4 { color: #1976d2; margin-bottom: 5px; }
        .retention-info p { color: #555; font-size: 0.9rem; margin: 0; }
        .retention-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .retention-table th, .retention-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .retention-table th { background: #f8f9fa; color: #667eea; font-weight: bold; }
        .retention-table tr:hover { background: #f8f9fa; }
        .retention-percent-cell { font-weight: bold; font-size: 1.1rem; }
        .retention-high { color: #4caf50; }
        .retention-medium { color: #ff9800; }
        .retention-low { color: #f44336; }
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .stat-value { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .control-row { flex-direction: column; align-items: flex-start; }
            .button-group { width: 100%; }
            .control-btn { flex: 1; }
        }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå± Bloom AI Dashboard</h1>
            <p class="update-time">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="updateTime">-</span></p>
            <p class="update-time pulse">üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</p>
        </header>

        <div id="error-container"></div>
        <div id="loading" class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

        <div id="today-stats" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="stat-value" id="total-users">-</div>
                    <div class="stat-percent"><span class="badge badge-success" id="new-users-today">-</span> –Ω–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíß</div>
                    <h3>–ü–æ–ª–∏–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è</h3>
                    <div class="stat-value" id="watered-count">-</div>
                    <div class="stat-percent" id="watered-percent">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üå±</div>
                    <h3>–î–æ–±–∞–≤–∏–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è</h3>
                    <div class="stat-value" id="added-count">-</div>
                    <div class="stat-percent" id="added-percent">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è</h3>
                    <div class="stat-value" id="active-count">-</div>
                    <div class="stat-percent" id="active-percent">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üò¥</div>
                    <h3>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è</h3>
                    <div class="stat-value" id="inactive-count">-</div>
                    <div class="stat-percent" id="inactive-percent">-</div>
                </div>
            </div>

            <div class="comparison">
                <h2>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –°–µ–≥–æ–¥–Ω—è vs –í—á–µ—Ä–∞</h2>
                <div class="comparison-grid">
                    <div class="day-stats">
                        <h3>üóìÔ∏è –°–µ–≥–æ–¥–Ω—è (<span id="today-date">-</span>)</h3>
                        <div class="day-stats-item"><span>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</span><strong id="today-new">-</strong></div>
                        <div class="day-stats-item"><span>–ü–æ–ª–∏–ª–∏:</span><strong id="today-watered">-</strong></div>
                        <div class="day-stats-item"><span>–î–æ–±–∞–≤–∏–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è:</span><strong id="today-added">-</strong></div>
                        <div class="day-stats-item"><span>–ê–∫—Ç–∏–≤–Ω—ã–µ:</span><strong id="today-active">-</strong></div>
                    </div>
                    <div class="day-stats">
                        <h3>üìÖ –í—á–µ—Ä–∞ (<span id="yesterday-date">-</span>)</h3>
                        <div class="day-stats-item"><span>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</span><strong id="yesterday-new">-</strong></div>
                        <div class="day-stats-item"><span>–ü–æ–ª–∏–ª–∏:</span><strong id="yesterday-watered">-</strong></div>
                        <div class="day-stats-item"><span>–î–æ–±–∞–≤–∏–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è:</span><strong id="yesterday-added">-</strong></div>
                        <div class="day-stats-item"><span>–ê–∫—Ç–∏–≤–Ω—ã–µ:</span><strong id="yesterday-active">-</strong></div>
                    </div>
                </div>
            </div>

            <div class="charts-section">
                <h2>üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üí¨</div>
                        <h3>–í–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–¥–∞–Ω–æ</h3>
                        <div class="stat-value" id="questions-count">-</div>
                        <div class="stat-percent">–ó–∞ –Ω–µ–¥–µ–ª—é: <span id="questions-week">-</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <h3>–û—Ç–∑—ã–≤–æ–≤ –ø–æ–ª—É—á–µ–Ω–æ</h3>
                        <div class="stat-value" id="feedback-count">-</div>
                        <div class="stat-percent">–ó–∞ –Ω–µ–¥–µ–ª—é: <span id="feedback-week">-</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üå±</div>
                        <h3>–í—ã—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Å –Ω—É–ª—è</h3>
                        <div class="stat-value" id="growing-active">-</div>
                        <div class="stat-percent">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: <span id="growing-completed">-</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üåø</div>
                        <h3>–í—Å–µ–≥–æ —Ä–∞—Å—Ç–µ–Ω–∏–π</h3>
                        <div class="stat-value" id="total-plants">-</div>
                        <div class="stat-percent">–í —Å—Ä–µ–¥–Ω–µ–º: <span id="avg-plants">-</span> –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                    </div>
                </div>
                <div class="day-stats" style="margin-top: 20px;">
                    <h3>üèÜ –¢–æ–ø-5 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π</h3>
                    <div id="top-plants-list"><div style="padding: 20px; text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
                </div>
            </div>

            <div class="charts-section">
                <h2>üìà –î–∏–Ω–∞–º–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
                <div class="control-panel">
                    <div class="control-row">
                        <span class="control-label">üìä –ì—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å:</span>
                        <div class="button-group">
                            <button class="control-btn active" data-granularity="day">üìÖ –î–µ–Ω—å</button>
                            <button class="control-btn" data-granularity="week">üìä –ù–µ–¥–µ–ª—è</button>
                            <button class="control-btn" data-granularity="month">üìÜ –ú–µ—Å—è—Ü</button>
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">‚è±Ô∏è –ü–µ—Ä–∏–æ–¥:</span>
                        <div class="button-group">
                            <button class="control-btn active" data-period="7d">Last 7 days</button>
                            <button class="control-btn" data-period="30d">Last 30 days</button>
                            <button class="control-btn" data-period="3m">Last 3 months</button>
                            <button class="control-btn" data-period="custom">Custom</button>
                        </div>
                    </div>
                    <div class="control-row custom-period-inputs">
                        <span class="control-label">üìÖ –î–∞—Ç—ã:</span>
                        <input type="date" class="date-input" id="date-from" />
                        <span>‚Üí</span>
                        <input type="date" class="date-input" id="date-to" />
                        <button class="control-btn" id="apply-custom-period">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="timeseriesChart"></canvas></div>
            </div>

            <div class="charts-section">
                <h2>üë§ –î–µ–π—Å—Ç–≤–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <div class="control-panel">
                    <div class="control-row">
                        <span class="control-label">üìä –ì—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å:</span>
                        <div class="button-group">
                            <button class="control-btn active" data-per-user-granularity="day">üìÖ –î–µ–Ω—å</button>
                            <button class="control-btn" data-per-user-granularity="week">üìä –ù–µ–¥–µ–ª—è</button>
                            <button class="control-btn" data-per-user-granularity="month">üìÜ –ú–µ—Å—è—Ü</button>
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">‚è±Ô∏è –ü–µ—Ä–∏–æ–¥:</span>
                        <div class="button-group">
                            <button class="control-btn active" data-per-user-period="7d">Last 7 days</button>
                            <button class="control-btn" data-per-user-period="30d">Last 30 days</button>
                            <button class="control-btn" data-per-user-period="3m">Last 3 months</button>
                            <button class="control-btn" data-per-user-period="custom">Custom</button>
                        </div>
                    </div>
                    <div class="control-row custom-period-inputs" id="per-user-custom-period">
                        <span class="control-label">üìÖ –î–∞—Ç—ã:</span>
                        <input type="date" class="date-input" id="per-user-date-from" />
                        <span>‚Üí</span>
                        <input type="date" class="date-input" id="per-user-date-to" />
                        <button class="control-btn" id="apply-per-user-custom-period">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="actionsPerUserChart"></canvas></div>
            </div>

            <div class="charts-section">
                <h2>üë• Retention Analysis - –í–æ–∑–≤—Ä–∞—â–∞–µ–º–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
                <div class="control-panel">
                    <div class="control-row">
                        <span class="control-label">üìä –¢–∏–ø Retention:</span>
                        <div class="button-group">
                            <button class="control-btn active" data-retention-type="classic">Classic Retention</button>
                            <button class="control-btn" data-retention-type="functional">Functional Retention</button>
                            <button class="control-btn" data-retention-type="rolling">Rolling Retention</button>
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">‚è±Ô∏è –ì—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å:</span>
                        <div class="button-group">
                            <button class="control-btn active" data-retention-granularity="day">üìÖ –î–µ–Ω—å</button>
                            <button class="control-btn" data-retention-granularity="week">üìä –ù–µ–¥–µ–ª—è</button>
                            <button class="control-btn" data-retention-granularity="month">üìÜ –ú–µ—Å—è—Ü</button>
                        </div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">üéØ –ü–µ—Ä–∏–æ–¥:</span>
                        <div class="button-group">
                            <button class="control-btn active" data-retention-period="7">Day 7</button>
                            <button class="control-btn" data-retention-period="30">Day 30</button>
                            <button class="control-btn" data-retention-period="1m">Month 1</button>
                            <button class="control-btn" data-retention-period="3m">Month 3</button>
                            <button class="control-btn" data-retention-period="custom">Custom</button>
                        </div>
                    </div>
                    <div class="control-row custom-period-inputs" id="retention-custom-period">
                        <span class="control-label">–ü–µ—Ä–∏–æ–¥ (<span id="retention-period-unit">–¥–Ω–µ–π</span>):</span>
                        <input type="number" class="period-input" id="retention-custom-value" min="1" max="365" value="7" />
                        <button class="control-btn" id="apply-retention-custom">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>

                <div class="retention-info" id="retention-info">
                    <h4>Classic Retention</h4>
                    <p>–ò–∑–º–µ—Ä—è–µ—Ç –ª—é–±—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (last_activity) —á–µ—Ä–µ–∑ N –¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
                </div>

                <div style="overflow-x: auto;">
                    <table class="retention-table">
                        <thead>
                            <tr>
                                <th>–ö–æ–≥–æ—Ä—Ç–∞</th>
                                <th>–¶–µ–ª–µ–≤–æ–π –ø–µ—Ä–∏–æ–¥</th>
                                <th>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</th>
                                <th>–í–µ—Ä–Ω—É–ª–∏—Å—å</th>
                                <th>Retention %</th>
                            </tr>
                        </thead>
                        <tbody id="retention-table-body">
                            <tr><td colspan="5" style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="chart-container" style="margin-top: 30px;">
                    <canvas id="retentionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentGranularity = 'day';
        let currentPeriod = '7d';
        let customDateFrom = null;
        let customDateTo = null;
        let currentPerUserGranularity = 'day';
        let currentPerUserPeriod = '7d';
        let customPerUserDateFrom = null;
        let customPerUserDateTo = null;
        let currentRetentionType = 'classic';
        let currentRetentionGranularity = 'day';
        let currentRetentionPeriod = 7;

        const retentionDescriptions = {
            classic: { title: 'Classic Retention', description: '–ò–∑–º–µ—Ä—è–µ—Ç –ª—é–±—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (last_activity) —á–µ—Ä–µ–∑ N –¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' },
            functional: { title: 'Functional Retention', description: '–ò–∑–º–µ—Ä—è–µ—Ç –ø–æ–ª–µ–∑–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –ø–æ–ª–∏–≤ —Ä–∞—Å—Ç–µ–Ω–∏–π, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π, –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö —á–µ—Ä–µ–∑ N –¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤' },
            rolling: { title: 'Rolling Retention', description: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ N –¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' }
        };

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
        }

        function showError(message) {
            document.getElementById('error-container').innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        function getRetentionColor(percent) {
            if (percent >= 30) return 'retention-high';
            if (percent >= 15) return 'retention-medium';
            return 'retention-low';
        }

        function calculatePeriodDates(period, customFrom = null, customTo = null) {
            const today = new Date();
            let from, to;
            switch(period) {
                case '7d':
                    from = new Date(today); from.setDate(from.getDate() - 7); to = today; break;
                case '30d':
                    from = new Date(today); from.setDate(from.getDate() - 30); to = today; break;
                case '3m':
                    from = new Date(today); from.setMonth(from.getMonth() - 3); to = today; break;
                case 'custom':
                    if (!customFrom || !customTo) return null;
                    from = new Date(customFrom); to = new Date(customTo); break;
                default: return null;
            }
            return { from: from.toISOString().split('T')[0], to: to.toISOString().split('T')[0] };
        }

        async function loadStats() {
            try {
                const [todayRes, yesterdayRes] = await Promise.all([
                    fetch('/api/stats/today'), fetch('/api/stats/yesterday')
                ]);
                const todayData = await todayRes.json();
                const yesterdayData = await yesterdayRes.json();

                document.getElementById('total-users').textContent = todayData.total_users;
                document.getElementById('new-users-today').textContent = `+${todayData.new_users}`;
                document.getElementById('watered-count').textContent = todayData.watered.count;
                document.getElementById('watered-percent').textContent = `${todayData.watered.percent}% –æ—Ç –±–∞–∑—ã`;
                document.getElementById('added-count').textContent = todayData.added_plants.count;
                document.getElementById('added-percent').textContent = `${todayData.added_plants.percent}% –æ—Ç –±–∞–∑—ã`;
                document.getElementById('active-count').textContent = todayData.active.count;
                document.getElementById('active-percent').textContent = `${todayData.active.percent}% –æ—Ç –±–∞–∑—ã`;
                document.getElementById('inactive-count').textContent = todayData.inactive.count;
                document.getElementById('inactive-percent').textContent = `${todayData.inactive.percent}% –æ—Ç –±–∞–∑—ã`;

                document.getElementById('today-date').textContent = formatDate(todayData.date);
                document.getElementById('today-new').textContent = todayData.new_users;
                document.getElementById('today-watered').textContent = `${todayData.watered.count} (${todayData.watered.percent}%)`;
                document.getElementById('today-added').textContent = `${todayData.added_plants.count} (${todayData.added_plants.percent}%)`;
                document.getElementById('today-active').textContent = `${todayData.active.count} (${todayData.active.percent}%)`;
                document.getElementById('yesterday-date').textContent = formatDate(yesterdayData.date);
                document.getElementById('yesterday-new').textContent = yesterdayData.new_users;
                document.getElementById('yesterday-watered').textContent = `${yesterdayData.watered.count} (${yesterdayData.watered.percent}%)`;
                document.getElementById('yesterday-added').textContent = `${yesterdayData.added_plants.count} (${yesterdayData.added_plants.percent}%)`;
                document.getElementById('yesterday-active').textContent = `${yesterdayData.active.count} (${yesterdayData.active.percent}%)`;

                const additionalRes = await fetch('/api/stats/additional');
                if (additionalRes.ok) {
                    const additionalData = await additionalRes.json();
                    document.getElementById('questions-count').textContent = additionalData.questions.today;
                    document.getElementById('questions-week').textContent = additionalData.questions.week;
                    document.getElementById('feedback-count').textContent = additionalData.feedback.today;
                    document.getElementById('feedback-week').textContent = additionalData.feedback.week;
                    document.getElementById('growing-active').textContent = additionalData.growing.active;
                    document.getElementById('growing-completed').textContent = additionalData.growing.completed;
                    document.getElementById('total-plants').textContent = additionalData.plants.total;
                    document.getElementById('avg-plants').textContent = additionalData.plants.avg_per_user;
                    const topPlantsHtml = additionalData.top_plants.map((plant, index) => 
                        `<div class="day-stats-item"><span>${index + 1}. ${plant.name}</span><strong>${plant.count} —à—Ç.</strong></div>`
                    ).join('');
                    document.getElementById('top-plants-list').innerHTML = topPlantsHtml || '<p style="padding: 10px; text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                }

                await loadTimeseriesData();
                await loadActionsPerUserData();
                await loadRetentionData();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('today-stats').style.display = 'block';
                document.getElementById('updateTime').textContent = new Date().toLocaleString('ru-RU');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError(error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadTimeseriesData() {
            try {
                const dates = calculatePeriodDates(currentPeriod, customDateFrom, customDateTo);
                if (!dates) return;
                const response = await fetch(`/api/stats/timeseries?granularity=${currentGranularity}&date_from=${dates.from}&date_to=${dates.to}`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ timeseries –¥–∞–Ω–Ω—ã—Ö');
                const data = await response.json();
                updateTimeseriesChart(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ timeseries:', error);
            }
        }

        function updateTimeseriesChart(data) {
            const canvas = document.getElementById('timeseriesChart');
            const existingChart = Chart.getChart('timeseriesChart');
            if (existingChart) existingChart.destroy();
            if (!data.data || data.data.length === 0) return;

            new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.data.map(d => d.label),
                    datasets: [
                        { label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', data: data.data.map(d => d.new_users), borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4 },
                        { label: '–ü–æ–ª–∏–≤—ã', data: data.data.map(d => d.watered), borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', tension: 0.4 },
                        { label: '–î–æ–±–∞–≤–∏–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ', data: data.data.map(d => d.added_plants), borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.1)', tension: 0.4 },
                        { label: '–î–æ–±–∞–≤–∏–ª–∏ —Ä–æ—Å—Ç —Å –Ω—É–ª—è', data: data.data.map(d => d.added_growing), borderColor: '#9c27b0', backgroundColor: 'rgba(156, 39, 176, 0.1)', tension: 0.4 },
                        { label: '–ó–∞–¥–∞–ª–∏ –≤–æ–ø—Ä–æ—Å', data: data.data.map(d => d.asked_question), borderColor: '#e91e63', backgroundColor: 'rgba(233, 30, 99, 0.1)', tension: 0.4 },
                        { label: '–û—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤', data: data.data.map(d => d.left_feedback), borderColor: '#ffc107', backgroundColor: 'rgba(255, 193, 7, 0.1)', tension: 0.4 },
                        { label: '–û—Ç–∫—Ä—ã–ª–∏ –±–æ—Ç–∞', data: data.data.map(d => d.opened_bot), borderColor: '#2196F3', backgroundColor: 'rgba(33, 150, 243, 0.1)', tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { display: true, text: `–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (${data.granularity === 'day' ? '–ø–æ –¥–Ω—è–º' : data.granularity === 'week' ? '–ø–æ –Ω–µ–¥–µ–ª—è–º' : '–ø–æ –º–µ—Å—è—Ü–∞–º'})` }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function loadActionsPerUserData() {
            try {
                const dates = calculatePeriodDates(currentPerUserPeriod, customPerUserDateFrom, customPerUserDateTo);
                if (!dates) return;
                const response = await fetch(`/api/stats/actions-per-user?granularity=${currentPerUserGranularity}&date_from=${dates.from}&date_to=${dates.to}`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ actions-per-user –¥–∞–Ω–Ω—ã—Ö');
                const data = await response.json();
                updateActionsPerUserChart(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ actions-per-user:', error);
            }
        }

        function updateActionsPerUserChart(data) {
            const canvas = document.getElementById('actionsPerUserChart');
            const existingChart = Chart.getChart('actionsPerUserChart');
            if (existingChart) existingChart.destroy();
            if (!data.data || data.data.length === 0) return;

            new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.data.map(d => d.label),
                    datasets: [
                        { label: '–ü–æ–ª–∏–≤—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', data: data.data.map(d => d.watered_per_user), borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', tension: 0.4 },
                        { label: '–î–æ–±–∞–≤–∏–ª —Ä–∞—Å—Ç–µ–Ω–∏–µ', data: data.data.map(d => d.added_plants_per_user), borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.1)', tension: 0.4 },
                        { label: '–†–æ—Å—Ç —Å –Ω—É–ª—è', data: data.data.map(d => d.added_growing_per_user), borderColor: '#9c27b0', backgroundColor: 'rgba(156, 39, 176, 0.1)', tension: 0.4 },
                        { label: '–ó–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å', data: data.data.map(d => d.asked_question_per_user), borderColor: '#e91e63', backgroundColor: 'rgba(233, 30, 99, 0.1)', tension: 0.4 },
                        { label: '–û—Å—Ç–∞–≤–∏–ª –æ—Ç–∑—ã–≤', data: data.data.map(d => d.left_feedback_per_user), borderColor: '#ffc107', backgroundColor: 'rgba(255, 193, 7, 0.1)', tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { display: true, text: `–î–µ–π—Å—Ç–≤–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (${data.granularity === 'day' ? '–ø–æ –¥–Ω—è–º' : data.granularity === 'week' ? '–ø–æ –Ω–µ–¥–µ–ª—è–º' : '–ø–æ –º–µ—Å—è—Ü–∞–º'})` }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function loadRetentionData() {
            try {
                const response = await fetch(`/api/stats/retention-flexible?retention_type=${currentRetentionType}&granularity=${currentRetentionGranularity}&period=${currentRetentionPeriod}`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ retention –¥–∞–Ω–Ω—ã—Ö');
                const data = await response.json();
                
                const info = retentionDescriptions[data.retention_type];
                document.getElementById('retention-info').innerHTML = `<h4>${info.title}</h4><p>${info.description}</p>`;

                const tbody = document.getElementById('retention-table-body');
                if (data.cohorts && data.cohorts.length > 0) {
                    tbody.innerHTML = data.cohorts.map(cohort => {
                        const colorClass = getRetentionColor(cohort.retention_percent);
                        return `<tr>
                            <td>${cohort.cohort_label}</td>
                            <td>${cohort.target_label}</td>
                            <td>${cohort.registered}</td>
                            <td>${cohort.returned}</td>
                            <td class="retention-percent-cell ${colorClass}">${cohort.retention_percent}%</td>
                        </tr>`;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }

                updateRetentionChart(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ retention:', error);
            }
        }

        function updateRetentionChart(data) {
            const canvas = document.getElementById('retentionChart');
            const existingChart = Chart.getChart('retentionChart');
            if (existingChart) existingChart.destroy();
            if (!data.cohorts || data.cohorts.length === 0) return;

            const cohorts = data.cohorts.slice(0, 15).reverse();
            new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: cohorts.map(c => c.cohort_label),
                    datasets: [{
                        label: 'Retention %',
                        data: cohorts.map(c => c.retention_percent),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { display: true, text: `${retentionDescriptions[data.retention_type].title} - ${data.granularity} ${data.period}` }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: function(value) { return value + '%'; } }
                        }
                    }
                }
            });
        }

        // Event handlers
        document.querySelectorAll('[data-granularity]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-granularity]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentGranularity = this.dataset.granularity;
                loadTimeseriesData();
            });
        });

        document.querySelectorAll('[data-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPeriod = this.dataset.period;
                if (currentPeriod === 'custom') {
                    document.querySelector('.custom-period-inputs').classList.add('active');
                } else {
                    document.querySelector('.custom-period-inputs').classList.remove('active');
                    loadTimeseriesData();
                }
            });
        });

        document.getElementById('apply-custom-period').addEventListener('click', function() {
            customDateFrom = document.getElementById('date-from').value;
            customDateTo = document.getElementById('date-to').value;
            if (customDateFrom && customDateTo) {
                loadTimeseriesData();
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã');
            }
        });

        // Event handlers –¥–ª—è Actions Per User
        document.querySelectorAll('[data-per-user-granularity]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-per-user-granularity]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPerUserGranularity = this.dataset.perUserGranularity;
                loadActionsPerUserData();
            });
        });

        document.querySelectorAll('[data-per-user-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-per-user-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPerUserPeriod = this.dataset.perUserPeriod;
                
                if (currentPerUserPeriod === 'custom') {
                    document.getElementById('per-user-custom-period').classList.add('active');
                } else {
                    document.getElementById('per-user-custom-period').classList.remove('active');
                    loadActionsPerUserData();
                }
            });
        });

        document.getElementById('apply-per-user-custom-period').addEventListener('click', function() {
            customPerUserDateFrom = document.getElementById('per-user-date-from').value;
            customPerUserDateTo = document.getElementById('per-user-date-to').value;
            if (customPerUserDateFrom && customPerUserDateTo) {
                loadActionsPerUserData();
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã');
            }
        });

        document.querySelectorAll('[data-retention-type]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-retention-type]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentRetentionType = this.dataset.retentionType;
                loadRetentionData();
            });
        });

        document.querySelectorAll('[data-retention-granularity]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-retention-granularity]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentRetentionGranularity = this.dataset.retentionGranularity;
                
                // Update period unit label
                const unit = currentRetentionGranularity === 'day' ? '–¥–Ω–µ–π' : currentRetentionGranularity === 'week' ? '–Ω–µ–¥–µ–ª—å' : '–º–µ—Å—è—Ü–µ–≤';
                document.getElementById('retention-period-unit').textContent = unit;
                
                // Update max value
                const maxVal = currentRetentionGranularity === 'day' ? 365 : currentRetentionGranularity === 'week' ? 52 : 12;
                document.getElementById('retention-custom-value').max = maxVal;
                
                loadRetentionData();
            });
        });

        document.querySelectorAll('[data-retention-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-retention-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const val = this.dataset.retentionPeriod;
                
                if (val === 'custom') {
                    document.getElementById('retention-custom-period').classList.add('active');
                } else {
                    document.getElementById('retention-custom-period').classList.remove('active');
                    
                    if (val === '1m') {
                        currentRetentionGranularity = 'month';
                        currentRetentionPeriod = 1;
                        document.querySelectorAll('[data-retention-granularity]').forEach(b => b.classList.remove('active'));
                        document.querySelector('[data-retention-granularity="month"]').classList.add('active');
                    } else if (val === '3m') {
                        currentRetentionGranularity = 'month';
                        currentRetentionPeriod = 3;
                        document.querySelectorAll('[data-retention-granularity]').forEach(b => b.classList.remove('active'));
                        document.querySelector('[data-retention-granularity="month"]').classList.add('active');
                    } else {
                        currentRetentionGranularity = 'day';
                        currentRetentionPeriod = parseInt(val);
                        document.querySelectorAll('[data-retention-granularity]').forEach(b => b.classList.remove('active'));
                        document.querySelector('[data-retention-granularity="day"]').classList.add('active');
                    }
                    loadRetentionData();
                }
            });
        });

        document.getElementById('apply-retention-custom').addEventListener('click', function() {
            const val = parseInt(document.getElementById('retention-custom-value').value);
            if (val > 0) {
                currentRetentionPeriod = val;
                loadRetentionData();
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞');
            }
        });

        loadStats();
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
